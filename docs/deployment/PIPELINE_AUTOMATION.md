# æ’åæ¬Šé‡è‡ªå‹•æ›´æ–°æ’ç¨‹ç³»çµ±

## æ¦‚è¿°

æœ¬ç³»çµ±å¯¦ç¾äº†å®Œæ•´çš„è‡ªå‹•åŒ– ML Pipelineï¼Œæ”¯æ´ï¼š
- å®šæœŸé—œéµå­—åŒ¯å‡º
- è‡ªå‹• SERP è’é›†
- æ¨¡å‹è‡ªå‹•è¨“ç·´èˆ‡éƒ¨ç½²
- æˆæœ¬ç›£æ§èˆ‡å ±è¡¨

## æ¶æ§‹

### æ ¸å¿ƒçµ„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Cloudflare Cron Triggers                      â”‚
â”‚  (é€±ä¸€ 02:00 / 02:30, é€±äºŒ 03:00 UTC)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Pipeline Scheduler (Durable Object)              â”‚
â”‚  - ç‹€æ…‹æ©Ÿç®¡ç†                                            â”‚
â”‚  - éšæ®µç·¨æ’                                              â”‚
â”‚  - å¤±æ•—é‡è©¦                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                 â–¼             â–¼              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚é—œéµå­—  â”‚        â”‚SERPè’é›† â”‚  â”‚æ¨¡å‹è¨“ç·´  â”‚  â”‚æˆæœ¬æ‘˜è¦  â”‚
   â”‚åŒ¯å‡ºAPI â”‚        â”‚API      â”‚  â”‚API       â”‚  â”‚API       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚             â”‚              â”‚
        â–¼                 â–¼             â–¼              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚R2å­˜å„²  â”‚        â”‚Google   â”‚  â”‚scoring-  â”‚  â”‚æˆæœ¬å ±è¡¨  â”‚
   â”‚        â”‚        â”‚Sheet    â”‚  â”‚model.js  â”‚  â”‚          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡çµ„åˆ†è§£

#### æ¨¡çµ„ 1ï¼šé—œéµå­—è³‡æ–™åŒ¯å‡º âœ… å®Œæˆ
- `scripts/export_keywords.py` - æœ¬åœ°åŒ¯å‡ºè…³æœ¬
- `functions/api/keywords/export.js` - Worker API ç«¯é»
- æ”¯æ´ JSON/CSV æ ¼å¼
- è‡ªå‹•ä¸Šå‚³è‡³ R2

#### æ¨¡çµ„ 2ï¼šSERP è’é›†æ‰¹æ¬¡åŒ–ï¼ˆå¾…å¯¦ä½œï¼‰
- é‡æ§‹ `ml/serp_collection.py` æ”¯æ´å¤–éƒ¨è¼¸å…¥
- Durable Object æ’ç¨‹ SERP ä»»å‹™
- æ‰¹æ¬¡ä¸Šå‚³è‡³ R2

#### æ¨¡çµ„ 3ï¼šè‡ªå‹•åŒ–æ¨¡å‹è¨“ç·´ï¼ˆå¾…å¯¦ä½œï¼‰
- `ml/train_model_cli.py` - éäº’å‹•è¨“ç·´è…³æœ¬
- æ¨¡å‹è½‰æª”æµç¨‹
- è‡ªå‹•æ›´æ–° `scoring-model.js`

#### æ¨¡çµ„ 4ï¼šç›£æ§èˆ‡æˆæœ¬è¿½è¹¤ï¼ˆå¾…å¯¦ä½œï¼‰
- æ“´å…… `cost_tracker.py`
- æ’ç¨‹å ±è¡¨ Worker
- Slack/Email é€šçŸ¥

#### æ¨¡çµ„ 5ï¼šæ’ç¨‹æ•´åˆï¼ˆå¾…å¯¦ä½œï¼‰
- Cron æ™‚ç¨‹è¨­è¨ˆ
- Pipeline ç‹€æ…‹æ©Ÿ
- å¥åº·æª¢æŸ¥ç«¯é»

## ä½¿ç”¨æŒ‡å—

### 1. ç’°å¢ƒé…ç½®

#### æœ¬åœ°é–‹ç™¼

```bash
# è¤‡è£½ç’°å¢ƒç¯„æœ¬
cp .env.example .env

# è¨­å®šå¿…è¦çš„ç’°å¢ƒè®Šæ•¸
export KEYWORD_EXPORT_API_URL="http://localhost:8787"
export KEYWORD_ANALYTICS_TOKEN="your-secret-token"
```

#### Cloudflare Worker ç’°å¢ƒ

```bash
# è¨­å®š Worker ç’°å¢ƒè®Šæ•¸
wrangler secret put KEYWORD_ANALYTICS_TOKEN
wrangler secret put SLACK_WEBHOOK_URL  # å¯é¸
wrangler secret put KEYWORD_EXPORT_API_URL

# å»ºç«‹ R2 bucket
wrangler r2 bucket create keyword-exports
```

### 2. é—œéµå­—åŒ¯å‡º

#### æ–¹å¼ Aï¼šä½¿ç”¨ Python è…³æœ¬ï¼ˆæœ¬åœ°ï¼‰

```bash
# åŸºæœ¬ç”¨æ³•
python3 scripts/export_keywords.py

# æŒ‡å®šè¼¸å‡ºæ ¼å¼
python3 scripts/export_keywords.py --format json --output-dir ./keywords-export

# æŒ‡å®šæ™‚é–“ç¯„åœ
python3 scripts/export_keywords.py \
  --since "2025-11-10T00:00:00Z" \
  --locale "zh-TW" \
  --limit 500

# å®Œæ•´é¸é …
python3 scripts/export_keywords.py \
  --api-url "https://api.example.com" \
  --api-token "your-token" \
  --format both \
  --date "2025-11-11" \
  --output-dir "./keywords-export"
```

#### æ–¹å¼ Bï¼šä½¿ç”¨ Worker APIï¼ˆé ç«¯ï¼‰

```bash
# å–å¾— JSON æ ¼å¼
curl -X GET "https://api.example.com/api/keywords/export?format=json&limit=200&uploadToR2=true" \
  -H "Authorization: Bearer your-token"

# å–å¾— CSV æ ¼å¼
curl -X GET "https://api.example.com/api/keywords/export?format=csv&limit=200" \
  -H "Authorization: Bearer your-token"

# ä½¿ç”¨ POST è«‹æ±‚ï¼ˆæ”¯æ´æ›´è¤‡é›œçš„åƒæ•¸ï¼‰
curl -X POST "https://api.example.com/api/keywords/export" \
  -H "Authorization: Bearer your-token" \
  -H "Content-Type: application/json" \
  -d '{
    "format": "json",
    "limit": 200,
    "since": "2025-11-10T00:00:00Z",
    "locale": "zh-TW",
    "uploadToR2": true
  }'
```

#### å›æ‡‰æ ¼å¼

```json
{
  "success": true,
  "format": "json",
  "count": 150,
  "filename": "keywords-2025-11-11.json",
  "r2Key": "keywords/2025-11-11/keywords-2025-11-11.json",
  "exportedAt": "2025-11-11T10:30:00Z"
}
```

### 3. Pipeline ç‹€æ…‹æŸ¥è©¢

```bash
# å–å¾— Pipeline ç‹€æ…‹
curl -X GET "https://api.example.com/pipeline/status" \
  -H "Authorization: Bearer your-token"

# å¥åº·æª¢æŸ¥
curl -X GET "https://api.example.com/pipeline/health" \
  -H "Authorization: Bearer your-token"

# å•Ÿå‹• Pipeline
curl -X POST "https://api.example.com/pipeline/start" \
  -H "Authorization: Bearer your-token" \
  -H "Content-Type: application/json" \
  -d '{
    "keywordLimit": 200,
    "locale": "zh-TW"
  }'

# é‡è©¦ç‰¹å®šéšæ®µ
curl -X POST "https://api.example.com/pipeline/retry/keyword_export" \
  -H "Authorization: Bearer your-token"

# å–æ¶ˆ Pipeline
curl -X POST "https://api.example.com/pipeline/cancel" \
  -H "Authorization: Bearer your-token"
```

### 4. Cron æ’ç¨‹

#### é è¨­æ™‚ç¨‹

| æ™‚é–“ | ä»»å‹™ | Cron è¡¨é”å¼ |
|------|------|-----------|
| é€±ä¸€ 02:00 UTC | é—œéµå­—åŒ¯å‡º | `0 2 * * 1` |
| é€±ä¸€ 02:30 UTC | SERP è’é›† | `0 2:30 * * 1` |
| é€±äºŒ 03:00 UTC | æ¨¡å‹è¨“ç·´ | `0 3 * * 2` |

#### è‡ªè¨‚æ™‚ç¨‹

ç·¨è¼¯ `wrangler.toml`ï¼š

```toml
[[triggers.crons]]
crons = ["0 2 * * 1"]  # è‡ªè¨‚æ™‚é–“

[[triggers.crons]]
crons = ["0 2:30 * * 1"]

[[triggers.crons]]
crons = ["0 3 * * 2"]
```

éƒ¨ç½²æ›´æ–°ï¼š

```bash
wrangler deploy
```

### 5. ç›£æ§èˆ‡é€šçŸ¥

#### Slack é€šçŸ¥

```bash
# è¨­å®š Slack Webhook
wrangler secret put SLACK_WEBHOOK_URL

# æ ¼å¼: https://hooks.slack.com/services/YOUR/WEBHOOK/URL
```

Pipeline åŸ·è¡Œæ™‚æœƒè‡ªå‹•ç™¼é€é€šçŸ¥ï¼š
- âœ… éšæ®µå®Œæˆ
- âŒ éšæ®µå¤±æ•—
- ğŸ“Š æˆæœ¬æ‘˜è¦

#### æ—¥èªŒæŸ¥è©¢

```bash
# æŸ¥çœ‹ Worker æ—¥èªŒ
wrangler tail

# æŸ¥çœ‹ç‰¹å®šéšæ®µçš„æ—¥èªŒ
wrangler tail --format json | grep "keyword_export"
```

## ç‹€æ…‹æ©Ÿ

### Pipeline ç‹€æ…‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    idle                                 â”‚
â”‚              (åˆå§‹ç‹€æ…‹/å®Œæˆå¾Œ)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ startPipeline()
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   running                               â”‚
â”‚         (åŸ·è¡Œå„éšæ®µçš„åºåˆ—æµç¨‹)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                 â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚completedâ”‚       â”‚failed    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚cancelled â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éšæ®µç‹€æ…‹

æ¯å€‹éšæ®µæœ‰ç¨ç«‹çš„ç‹€æ…‹ï¼š
- `pending` - ç­‰å¾…åŸ·è¡Œ
- `running` - åŸ·è¡Œä¸­
- `completed` - æˆåŠŸå®Œæˆ
- `failed` - åŸ·è¡Œå¤±æ•—

## æ•…éšœæ’é™¤

### å•é¡Œ 1ï¼šé—œéµå­—åŒ¯å‡ºå¤±æ•—

**ç—‡ç‹€**ï¼š`401 Unauthorized`

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
# é©—è­‰ Token
wrangler secret list | grep KEYWORD_ANALYTICS_TOKEN

# é‡æ–°è¨­å®š Token
wrangler secret put KEYWORD_ANALYTICS_TOKEN
```

### å•é¡Œ 2ï¼šR2 ä¸Šå‚³å¤±æ•—

**ç—‡ç‹€**ï¼š`R2 bucket æœªè¨­å®š`

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
# å»ºç«‹ bucket
wrangler r2 bucket create keyword-exports

# é©—è­‰ wrangler.toml é…ç½®
cat wrangler.toml | grep -A 3 "r2_buckets"
```

### å•é¡Œ 3ï¼šCron æœªè§¸ç™¼

**ç—‡ç‹€**ï¼šPipeline æœªåœ¨é å®šæ™‚é–“åŸ·è¡Œ

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
# é©—è­‰ Cron é…ç½®
wrangler deployments list

# æª¢æŸ¥ Worker æ—¥èªŒ
wrangler tail --format json

# æ‰‹å‹•è§¸ç™¼æ¸¬è©¦
curl -X POST "https://api.example.com/pipeline/start" \
  -H "Authorization: Bearer your-token"
```

## æˆæœ¬ä¼°ç®—

### æ¯æœˆæˆæœ¬ï¼ˆå‡è¨­ 1000 æ¬¡ Pipeline åŸ·è¡Œï¼‰

| æœå‹™ | ç”¨é‡ | æˆæœ¬ |
|------|------|------|
| Cloudflare Worker | 1000 æ¬¡ | $0 (å…è²»å±¤) |
| Durable Object | 1000 æ¬¡ | $0.15 |
| R2 å­˜å„² | 100 GB | $1.50 |
| KV å­˜å„² | 10 GB | $0.50 |
| **åˆè¨ˆ** | - | **~$2.15** |

## æœ€ä½³å¯¦è¸

1. **ç›£æ§ Pipeline ç‹€æ…‹**
   - å®šæœŸæª¢æŸ¥ `/pipeline/health` ç«¯é»
   - è¨­å®š Slack é€šçŸ¥

2. **å‚™ä»½é—œéµå­—è³‡æ–™**
   - å®šæœŸä¸‹è¼‰ R2 ä¸­çš„é—œéµå­—åŒ¯å‡º
   - ä¿ç•™è‡³å°‘ 30 å¤©çš„æ­·å²è¨˜éŒ„

3. **æ¸¬è©¦ Cron æ’ç¨‹**
   - åœ¨é ç™¼å¸ƒç’°å¢ƒå…ˆæ¸¬è©¦
   - ç¢ºèªæ™‚å€è¨­å®šæ­£ç¢ºï¼ˆUTCï¼‰

4. **æˆæœ¬æ§åˆ¶**
   - ç›£æ§ API å‘¼å«æ¬¡æ•¸
   - å®šæœŸæª¢æŸ¥ R2 å­˜å„²ä½¿ç”¨é‡

## ä¸‹ä¸€æ­¥

- [ ] æ¨¡çµ„ 2ï¼šSERP è’é›†æ‰¹æ¬¡åŒ–
- [ ] æ¨¡çµ„ 3ï¼šè‡ªå‹•åŒ–æ¨¡å‹è¨“ç·´
- [ ] æ¨¡çµ„ 4ï¼šç›£æ§èˆ‡æˆæœ¬è¿½è¹¤
- [ ] æ¨¡çµ„ 5ï¼šæ’ç¨‹æ•´åˆèˆ‡ QA
- [ ] ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²
- [ ] ç›£æ§èˆ‡å„ªåŒ–

## ç›¸é—œæ–‡ä»¶

- [SERP è’é›†æŒ‡å—](./SERP_QUICK_START.md)
- [æ¨¡å‹è¨“ç·´æŒ‡å—](../product/V5_USAGE_GUIDE.md)
- [æˆæœ¬è¿½è¹¤æŒ‡å—](../product/COST_TRACKING.md)
