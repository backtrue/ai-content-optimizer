# v5 自適應混合評分模型 - 變更日誌

## 概述
v5 模型是對 v1 評分機制的重大升級，將評分拆分為 **40% 結構分 + 60% AI 策略分**，支援 HTML 與純文字雙模式，並引入非同步 Email 通知流程。

## 核心改變

### 1. 評分架構升級
**v1（舊）**
- 單一綜合評分（0-100）
- 依賴複雜的樹狀判斷邏輯
- 對純文字輸入評分過低
- 無法區分「結構」與「內容策略」

**v5（新）**
- 雙軌評分：結構分（40%）+ 策略分（60%）
- 結構分：客觀訊號計算，穩定且快速
- 策略分：AI 質化評估（WHY/HOW/WHAT 框架）
- 自動適應 HTML vs 純文字模式

### 2. 結構分（40%）計算

#### Mode A - HTML 內容
- **標題結構**（15%）：H1/H2 層級檢查
- **內容組織**（12%）：段落、清單、表格計數
- **可讀性**（10%）：句子長度、段落長度
- **證據**（15%）：引用、數據、年份
- **經驗**（12%）：案例、第一手敘述
- **新鮮度**（8%）：發布日期、更新訊號
- **行動性**（10%）：步驟、指南、清單
- **語意品質**（8%）：詞彙多樣性、標題匹配

#### Mode B - 純文字內容
- **內容長度**（15%）：字數（理想 1000+ 字）
- **內容組織**（15%）：段落結構
- **可讀性**（15%）：句子與段落長度
- **證據**（20%）：引用、數據、年份
- **經驗**（15%）：案例、敘述
- **行動性**（10%）：步驟、指南
- **新鮮度**（10%）：更新訊號

### 3. 策略分（60%）計算

#### WHY / HOW / WHAT 框架
基於 Gemini AI 的質化評估，每個維度 1-10 分：

1. **WHY - 問題定義**
   - 是否清楚描繪讀者痛點？
   - 開篇是否交代「為什麼讀者需要這篇文章」？
   - 高分：具體指出挑戰、痛點、疑問
   - 低分：直接進入解決方案，缺乏問題鋪陳

2. **HOW - 實現方法**
   - 是否解釋解決方案的原理與步驟？
   - 是否提供「如何」執行的具體指引？
   - 高分：分步驟說明、實務建議、舉例
   - 低分：僅列舉結論，缺乏細節

3. **WHAT - 解決方案**
   - 解決方案是否切實回應初始問題？
   - 是否清楚總結「解決方案是什麼」及其價值？
   - 高分：結尾明確總結、強調對讀者的幫助
   - 低分：模糊、與問題脫節、缺乏結論

#### 總分計算
```
策略分 = (WHY + HOW + WHAT) / 3 × 10
```

### 4. 最終評分
```
v5 總分 = 結構分 × 0.4 + 策略分 × 0.6
```

## 非同步流程

### 新增功能
- **Email 輸入**：使用者提交內容時輸入 Email
- **後台排隊**：任務進入 Cloudflare Queue
- **非同步分析**：後台執行分析，不阻塞前端
- **Email 通知**：分析完成後寄送結果連結
- **結果查詢**：使用者透過 Email 連結查看完整結果

### 技術棧
- **任務隊列**：Cloudflare Queues
- **結果儲存**：Cloudflare KV（7 天過期）
- **Email 服務**：Resend
- **查詢端點**：`/api/results/[taskId]`

## 前端變更

### 新增組件
1. **AsyncAnalysisFlow.jsx**
   - Email 輸入表單
   - 提交狀態提示
   - 任務 ID 顯示

2. **V5ResultsDashboard.jsx**
   - 雙分數顯示（結構 + 策略）
   - 細項分數圖表
   - WHY/HOW/WHAT 視覺化
   - 改進建議列表

### 移除功能
- 舊的單一評分儀表板
- 同步分析流程（改為非同步）

## API 變更

### 請求格式
```json
{
  "content": "文章內容",
  "targetKeywords": ["關鍵字1", "關鍵字2"],
  "contentFormatHint": "plain|html|auto",
  "email": "user@example.com"  // 非同步流程需要
}
```

### 回應格式
```json
{
  "v5Scores": {
    "structureScore": 75,
    "strategyScore": 65,
    "overallScore": 70,
    "breakdown": {
      "structure": { ... },
      "strategy": { "why": 7, "how": 6, "what": 6 }
    },
    "recommendations": [ ... ]
  },
  "contentSignals": { ... },
  "recommendations": [ ... ]
}
```

### 新增端點
- `POST /api/analyze` - 提交非同步分析（需要 Email）
- `GET /api/results/[taskId]` - 查詢分析結果

## 測試與驗證

### 黃金測試集
- 3 個代表性測試用例
- 涵蓋不同內容類型
- 預期 WHY/HOW/WHAT 分數範圍
- 穩定性驗證（標準差 < 1.5）

### 執行測試
```bash
node tests/run-golden-tests.js
```

## 遷移指南

### 對現有使用者的影響
1. **評分變更**：新評分與舊評分不可直接比較
2. **流程變更**：從同步改為非同步（需提供 Email）
3. **結果查詢**：透過 Email 連結而非即時頁面

### 建議
- 通知使用者新的評分體系
- 提供 Email 通知的優勢說明
- 準備 FAQ 文檔

## 成本與效能

### 成本估算
- **Gemini API**：每次分析約 $0.001-0.002
- **Resend Email**：每封 $0.0001
- **Cloudflare KV**：儲存成本低

### 效能指標
- **結構分計算**：< 100ms
- **策略分計算**：1-3 秒（Gemini API）
- **Email 寄送**：< 500ms

## 已知限制

1. **策略分穩定性**：Gemini 回應可能存在 ±1-2 分的變動
2. **語言支援**：目前優化中文，英文支援有限
3. **內容類型**：WHY/HOW/WHAT 框架適用於教育/指南類內容，新聞類內容評分可能偏低

## 未來改進

- [ ] 支援多語言 Prompt
- [ ] 針對不同內容類型的 Prompt 變體
- [ ] 實時分析進度追蹤
- [ ] 批量分析支援
- [ ] 結果歷史記錄與對比

## 聯絡與支援

如有問題或建議，請聯絡產品團隊。
