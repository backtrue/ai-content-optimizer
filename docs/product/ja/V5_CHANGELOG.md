# v5 適応型ハイブリッドスコアリングモデル - 変更ログ

## 概要
v5 モデルは v1 スコアリング機構の大幅なアップグレードで、スコアを **40% 構造 + 60% AI 戦略**に分割し、HTML とプレーンテキストの両方のモードをサポートし、非同期メール通知ワークフローを導入しています。

## コアの変更

### 1. スコアリングアーキテクチャのアップグレード
**v1（旧）**
- 単一の複合スコア（0～100）
- 複雑なツリーベースの判定ロジック
- プレーンテキスト入力を過小評価
- 「構造」と「コンテンツ戦略」を区別できない

**v5（新）**
- デュアルトラックスコアリング：構造（40%）+ 戦略（60%）
- 構造スコア：客観的シグナル計算、安定で高速
- 戦略スコア：AI 定性評価（WHY/HOW/WHAT フレームワーク）
- HTML vs プレーンテキストモードに自動適応

### 2. 構造スコア（40%）計算

#### モード A - HTML コンテンツ
- **見出し構造**（15%）：H1/H2 階層チェック
- **コンテンツ組織**（12%）：段落、リスト、表のカウント
- **可読性**（10%）：文の長さ、段落の長さ
- **証拠**（15%）：引用、データ、日付
- **経験**（12%）：ケーススタディ、第一人称の叙述
- **新鮮さ**（8%）：公開日、更新シグナル
- **実行可能性**（10%）：ステップ、ガイド、リスト
- **セマンティック品質**（8%）：語彙の多様性、見出しマッチ

#### モード B - プレーンテキストコンテンツ
- **コンテンツの長さ**（15%）：文字数（理想 1000+ 文字）
- **コンテンツ組織**（15%）：段落構造
- **可読性**（15%）：文と段落の長さ
- **証拠**（20%）：引用、データ、日付
- **経験**（15%）：ケーススタディ、叙述
- **実行可能性**（10%）：ステップ、ガイド
- **新鮮さ**（10%）：更新シグナル

### 3. 戦略スコア（60%）計算

#### WHY / HOW / WHAT フレームワーク
Gemini AI に基づく定性評価、各次元 1～10 点：

1. **WHY - 問題定義**
   - 読者の痛点を明確に説明していますか？
   - 冒頭で「読者がこの記事を必要とする理由」を説明していますか？
   - 高スコア：具体的な課題、痛点、疑問を指摘
   - 低スコア：ソリューションに直接進む、問題の説明が不足

2. **HOW - 実装方法**
   - ソリューションの原理とステップを説明していますか？
   - 「実行方法」の具体的なガイダンスを提供していますか？
   - 高スコア：ステップバイステップの説明、実践的なアドバイス、例
   - 低スコア：結論のみ、詳細が不足

3. **WHAT - ソリューション**
   - ソリューションは最初の問題に本当に対応していますか？
   - 「ソリューションとは何か」とその価値を明確に要約していますか？
   - 高スコア：明確な結論、読者への利益を強調
   - 低スコア：曖昧、問題から乖離、結論が不足

#### 総合戦略スコア計算
```
戦略スコア = (WHY + HOW + WHAT) / 3 × 10
```

### 4. 最終スコア
```
v5 総合スコア = 構造スコア × 0.4 + 戦略スコア × 0.6
```

## 非同期ワークフロー

### 新機能
- **メール入力**：ユーザーはコンテンツ送信時にメールを入力
- **バックグラウンドキューイング**：タスクが Cloudflare Queue に入る
- **非同期分析**：バックエンドが分析を実行、フロントエンドをブロックしない
- **メール通知**：分析完了時に結果リンクが送信される
- **結果クエリ**：ユーザーがメールリンク経由で完全な結果を表示

### テクノロジースタック
- **タスクキュー**：Cloudflare Queues
- **結果ストレージ**：Cloudflare KV（7 日間有効期限）
- **メールサービス**：Resend
- **クエリエンドポイント**：`/api/results/[taskId]`

## フロントエンドの変更

### 新しいコンポーネント
1. **AsyncAnalysisFlow.jsx**
   - メール入力フォーム
   - 送信ステータスインジケーター
   - タスク ID 表示

2. **V5ResultsDashboard.jsx**
   - デュアルスコア表示（構造 + 戦略）
   - 詳細なスコアチャート
   - WHY/HOW/WHAT ビジュアライゼーション
   - 改善提案リスト

### 削除された機能
- 旧単一スコアダッシュボード
- 同期分析フロー（非同期に置き換え）

## API の変更

### リクエスト形式
```json
{
  "content": "記事コンテンツ",
  "targetKeywords": ["キーワード1", "キーワード2"],
  "contentFormatHint": "plain|html|auto",
  "email": "user@example.com"  // 非同期フロー用
}
```

### レスポンス形式
```json
{
  "v5Scores": {
    "structureScore": 75,
    "strategyScore": 65,
    "overallScore": 70,
    "breakdown": {
      "structure": { ... },
      "strategy": { "why": 7, "how": 6, "what": 6 }
    },
    "recommendations": [ ... ]
  },
  "contentSignals": { ... },
  "recommendations": [ ... ]
}
```

### 新しいエンドポイント
- `POST /api/analyze` - 非同期分析を送信（メール必須）
- `GET /api/results/[taskId]` - 分析結果をクエリ

## テストと検証

### ゴールデンテストセット
- 3 つの代表的なテストケース
- 異なるコンテンツタイプをカバー
- 予想される WHY/HOW/WHAT スコア範囲
- 安定性検証（標準偏差 < 1.5）

### テストを実行
```bash
node tests/run-golden-tests.js
```

## 移行ガイド

### 既存ユーザーへの影響
1. **スコア変更**：新しいスコアと古いスコアは直接比較できません
2. **ワークフロー変更**：同期から非同期へ（メール必須）
3. **結果アクセス**：即座のページではなくメールリンク経由

### 推奨事項
- ユーザーに新しいスコアリングシステムを通知
- メール通知の利点を説明
- FAQ ドキュメントを準備

## コストとパフォーマンス

### コスト推定
- **Gemini API**：分析あたり約 $0.001～0.002
- **Resend メール**：メールあたり $0.0001
- **Cloudflare KV**：ストレージコスト低

### パフォーマンス指標
- **構造スコア計算**：< 100ms
- **戦略スコア計算**：1～3 秒（Gemini API）
- **メール配信**：< 500ms

## 既知の制限

1. **戦略スコアの安定性**：Gemini の応答は ±1～2 点の変動がある可能性
2. **言語サポート**：現在中国語に最適化、英語サポートは限定的
3. **コンテンツタイプ**：WHY/HOW/WHAT フレームワークは教育/ガイドコンテンツに最適、ニュースコンテンツはスコアが低い可能性

## 将来の改善

- [ ] 多言語プロンプトサポート
- [ ] 異なるコンテンツタイプのプロンプト変種
- [ ] リアルタイム分析進捗追跡
- [ ] バッチ分析サポート
- [ ] 結果履歴と比較

## サポートに連絡

ご質問やご提案がある場合は、製品チームにお問い合わせください。
