# v5 部署檢查清單

## 📋 預發布環境部署

### 環境準備
- [ ] 預發布環境 Cloudflare 帳號已配置
- [ ] 預發布環境 KV 命名空間已建立
- [ ] 預發布環境 Durable Objects 已配置
- [ ] 預發布環境 Email 服務（Resend）已配置
- [ ] 預發布環境 Gemini API Key 已設定

### 代碼檢查
- [ ] 所有 TODO 註解已解決
- [ ] 無 console.log 或 debugger 留在生產代碼中
- [ ] 環境變數使用 `process.env` 或 `env` 物件
- [ ] 錯誤處理完整（try-catch, 錯誤日誌）
- [ ] 無硬編碼的 API Key 或敏感資訊

### 前端檢查
- [ ] 所有組件已測試（ScoreCard, ResultsDashboard, Recommendations）
- [ ] 展開式說明 UI 運作正常
- [ ] 中文文案完整無誤
- [ ] 響應式設計在手機/平板/桌面都正常
- [ ] 無控制台錯誤或警告

### 後端檢查
- [ ] 結構分計算邏輯正確（Mode A/B）
- [ ] 策略分計算邏輯正確（WHY/HOW/WHAT）
- [ ] 非同步隊列處理正常
- [ ] Email 模板渲染正確
- [ ] 結果查詢端點可訪問

### 集成測試
- [ ] 同步分析流程完整（輸入 → 分析 → 輸出）
- [ ] 非同步分析流程完整（提交 → Queue → Email → 查詢）
- [ ] 錯誤情況處理（缺少內容、API 超時、配額不足）
- [ ] 邊界情況測試（超長內容、特殊字符、多語言）

### 性能檢查
- [ ] 同步分析回應時間 < 10 秒
- [ ] 非同步分析進入 Queue < 1 秒
- [ ] Email 寄送延遲 < 30 秒
- [ ] 結果查詢回應時間 < 500ms

### 安全檢查
- [ ] CORS 設定正確
- [ ] 無 SQL 注入漏洞
- [ ] 無 XSS 漏洞
- [ ] API 速率限制已設定
- [ ] 敏感資訊已加密

---

## 📊 黃金測試集驗證

### 執行測試
```bash
# 確保預發布環境 API 可訪問
API_ENDPOINT=https://staging.example.com/api/analyze npm run test:golden
```

### 驗收標準
- [ ] 通過率 ≥ 80%
- [ ] 所有維度標準差 < 1.5
- [ ] 平均分在預期範圍內
- [ ] 無超時或 API 錯誤

### 結果記錄
- [ ] 測試結果已保存至 `tests/golden-test-results-staging.json`
- [ ] 結果已評審並簽核

---

## 🔄 E2E 非同步流程測試

### 執行測試
```bash
# 執行 E2E 測試
npm run test:e2e
```

### 驗收標準
- [ ] Email 提交成功
- [ ] 任務進入 Queue
- [ ] 分析完成並儲存結果
- [ ] Email 通知寄出
- [ ] 結果可透過連結查詢

### 結果記錄
- [ ] 測試結果已保存
- [ ] 結果已評審並簽核

---

## 💰 成本與容量監控

### 1 週監控期間
- [ ] 收集至少 100 次分析請求的數據
- [ ] 記錄 Gemini API 成本
- [ ] 記錄平均回應時間與 P95/P99
- [ ] 記錄錯誤率與失敗原因

### 監控指標達成
- [ ] 平均回應時間 < 10 秒
- [ ] 錯誤率 < 1%
- [ ] 成本在預算範圍內
- [ ] 無異常峰值或波動

### 監控報告
- [ ] 報告已生成（`monitoring-report-staging.json`）
- [ ] 報告已評審
- [ ] 優化建議已記錄

---

## 🚀 生產環境部署前檢查

### 最終驗收
- [ ] 預發布環境測試全部通過
- [ ] 黃金測試集驗收通過
- [ ] E2E 測試驗收通過
- [ ] 成本與容量監控達成目標
- [ ] 所有文檔已更新

### 部署計畫
- [ ] 部署時間已排定
- [ ] 回滾計畫已準備
- [ ] 監控告警已設定
- [ ] 支援團隊已培訓

### 部署步驟
1. [ ] 備份生產環境配置
2. [ ] 部署新版本代碼
3. [ ] 驗證部署成功
4. [ ] 執行冒煙測試（smoke test）
5. [ ] 監控初期運行
6. [ ] 逐步增加流量

---

## 📈 生產環境上線後

### 初期監控（第 1 週）
- [ ] 每日檢查錯誤率
- [ ] 每日檢查回應時間
- [ ] 每日檢查 API 配額使用
- [ ] 記錄用戶反饋

### 穩定性監控（第 2-4 週）
- [ ] 每週生成監控報告
- [ ] 分析性能趨勢
- [ ] 評估優化需求
- [ ] 調整參數或策略

### 長期監控（第 1 個月後）
- [ ] 月度成本報告
- [ ] 月度性能報告
- [ ] 用戶滿意度調查
- [ ] 改進建議評估

---

## 🔧 常見問題與應急方案

### 問題 1：回應時間過長
**症狀**：平均回應時間 > 15 秒  
**應急方案**：
1. 檢查 Gemini API 配額
2. 臨時降低 max_tokens 參數
3. 啟用 OpenAI 備援
4. 聯絡 Gemini 支援

### 問題 2：錯誤率過高
**症狀**：錯誤率 > 2%  
**應急方案**：
1. 檢查 API 日誌
2. 驗證 JSON 解析邏輯
3. 增加重試機制
4. 考慮回滾至上一版本

### 問題 3：Email 未寄出
**症狀**：Email 通知延遲或未送達  
**應急方案**：
1. 檢查 Resend API 配額
2. 驗證 Email 模板渲染
3. 檢查收件人地址有效性
4. 查看 Email 垃圾郵件夾

### 問題 4：KV 儲存失敗
**症狀**：結果無法查詢  
**應急方案**：
1. 檢查 KV 命名空間配置
2. 驗證 taskId 格式
3. 檢查 KV 儲存限制
4. 考慮增加 KV 容量

---

## ✅ 簽核與批准

| 角色 | 名稱 | 簽核日期 | 備註 |
|------|------|--------|------|
| 開發主管 | | | |
| QA 主管 | | | |
| 產品經理 | | | |
| 技術總監 | | | |

---

**最後更新**：2025-11-09  
**版本**：v5.0  
**部署狀態**：待預發布環境驗證
