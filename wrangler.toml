name = "ai-content-optimizer-worker"
main = "functions/api/[[path]].js"
compatibility_date = "2024-10-28"

# KV Namespace for storing analysis results
[[kv_namespaces]]
binding = "ANALYSIS_RESULTS"
id = "26377e2774624d0781a19b026e018b5f"
preview_id = "26377e2774624d0781a19b026e018b5f"

[[kv_namespaces]]
binding = "KEYWORD_ANALYTICS"
id = "a9644f456d684858897178a664b47633"
preview_id = "a9644f456d684858897178a664b47633"

# R2 Bucket for keyword exports and training data
[[r2_buckets]]
binding = "KEYWORD_EXPORTS_BUCKET"
bucket_name = "keyword-exports"
preview_bucket_name = "keyword-exports-preview"

# Durable Object for async analysis queue (replaces Queues for free plan)
[[durable_objects.bindings]]
name = "ANALYSIS_QUEUE"
class_name = "AnalysisQueue"
script_name = "ai-content-optimizer-worker"

# Durable Object for pipeline scheduling
[[durable_objects.bindings]]
name = "PIPELINE_SCHEDULER"
class_name = "PipelineScheduler"
script_name = "ai-content-optimizer-worker"

# Durable Object for SERP collection scheduling
[[durable_objects.bindings]]
name = "SERP_COLLECTION_SCHEDULER"
class_name = "SerpCollectionScheduler"
script_name = "ai-content-optimizer-worker"

# Durable Object for model deployment scheduling
[[durable_objects.bindings]]
name = "MODEL_DEPLOYMENT_SCHEDULER"
class_name = "ModelDeploymentScheduler"
script_name = "ai-content-optimizer-worker"

# Durable Object for reporting and monitoring
[[durable_objects.bindings]]
name = "REPORTING_SCHEDULER"
class_name = "ReportingScheduler"
script_name = "ai-content-optimizer-worker"

# Durable Object migrations (use SQLite for free plan)
[[migrations]]
tag = "v1"
new_sqlite_classes = ["AnalysisQueue"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["PipelineScheduler", "SerpCollectionScheduler", "ModelDeploymentScheduler", "ReportingScheduler"]

[env.production]
name = "ai-content-optimizer-worker-prod"
routes = [
  { pattern = "ragseo.thinkwithblack.com/api/analyze-worker", zone_name = "thinkwithblack.com" }
]

# Cron triggers for automated pipeline (production)
[[env.production.triggers.crons]]
crons = ["0 2 * * 1"]  # 每週一 02:00 UTC - 關鍵字匯出

[[env.production.triggers.crons]]
crons = ["30 2 * * 1"]  # 每週一 02:30 UTC - SERP 蒐集

[[env.production.triggers.crons]]
crons = ["0 3 * * 2"]  # 每週二 03:00 UTC - 模型訓練與部署

[[env.production.triggers.crons]]
crons = ["30 3 * * 2"]  # 每週二 03:30 UTC - 成本摘要與週報

[[env.production.kv_namespaces]]
binding = "ANALYSIS_RESULTS"
id = "analysis_results_prod"

[[env.production.kv_namespaces]]
binding = "KEYWORD_ANALYTICS"
id = "f8568cf53b1b4f579627585fcc9cd040"

[[env.production.durable_objects.bindings]]
name = "ANALYSIS_QUEUE"
class_name = "AnalysisQueue"
script_name = "ai-content-optimizer-worker-prod"

[[env.production.migrations]]
tag = "v1"
new_sqlite_classes = ["AnalysisQueue"]
